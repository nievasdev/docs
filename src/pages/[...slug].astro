---
import Layout from '../layouts/Layout.astro';
import Sidebar from '../components/Sidebar.astro';
import ContentRenderer from '../components/ContentRenderer.astro';
import { extractAllPaths } from '../utils/menuLoader';

export async function getStaticPaths() {
  const allPaths = await extractAllPaths();

  return allPaths.map(path => ({
    params: { slug: path.slug },
    props: {
      title: path.title,
      content: path.content
    }
  }));
}

const { title, content } = Astro.props;
const { breadcrumb = ['Inicio'], html = '', comments = [] } = content || {};
---

<Layout title={`${title} - Docs`}>
  <div class="sidebar-overlay" id="sidebar-overlay"></div>

  <main class="docs-layout">
    <Sidebar />

    <div class="content">
      <button class="menu-toggle" aria-label="Toggle menu" id="menu-toggle" onclick="playTerminalSound()">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <div class="breadcrumb">
        {breadcrumb.map((crumb, index) => (
          <>
            {index === 0 ? (
              <a href="/" onclick="playTerminalSound()">{crumb}</a>
            ) : index === breadcrumb.length - 1 ? (
              <span>{crumb}</span>
            ) : (
              <a href="#" onclick="playTerminalSound()">{crumb}</a>
            )}
            {index < breadcrumb.length - 1 && <span>›</span>}
          </>
        ))}
      </div>

      <div class="content-header">
        <h1>{title}</h1>
      </div>

      <div class="content-with-comments">
        <section class="main-content">
          <ContentRenderer html={html} />
        </section>
      </div>

      {comments.length > 0 && (
        <>
          <button class="comments-toggle" id="comments-toggle" onclick="playTerminalSound()" title="Comentarios">
            <span class="toggle-icon">›</span>
          </button>
          <aside class="comments-sidebar" id="comments-sidebar">
            <div class="comments-container">
              {comments.map(comment => (
                <div class="side-comment" data-comment-id={comment.id}>
                  <div class="comment-content">{comment.text}</div>
                </div>
              ))}
            </div>
          </aside>
        </>
      )}
    </div>
  </main>

  <script>
    // Mobile menu toggle
    const m = document.getElementById('menu-toggle');
    const s = document.querySelector('.sidebar');
    const o = document.getElementById('sidebar-overlay');

    function p() {
      s?.classList.add('mobile-open');
      o?.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function c() {
      s?.classList.remove('mobile-open');
      o?.classList.remove('active');
      document.body.style.overflow = '';
    }

    m?.addEventListener('click', () => {
      s?.classList.contains('mobile-open') ? c() : p();
    });

    o?.addEventListener('click', () => {
      if (typeof playTerminalSound === 'function') {
        playTerminalSound();
      }
      c();
    });

    s?.querySelectorAll('a').forEach(l => l.addEventListener('click', c));

    // Comments sidebar toggle
    const commentsToggle = document.getElementById('comments-toggle');
    const commentsSidebar = document.getElementById('comments-sidebar');

    commentsToggle?.addEventListener('click', () => {
      const isOpen = commentsSidebar?.classList.toggle('open');
      const icon = commentsToggle?.querySelector('.toggle-icon');
      if (icon) {
        icon.textContent = isOpen ? '‹' : '›';
      }
    });

    // Highlight comment markers on hover
    document.querySelectorAll('.comment-marker').forEach(marker => {
      const commentId = marker.getAttribute('data-comment-id');
      const commentEl = document.querySelector(`.side-comment[data-comment-id="${commentId}"]`);

      if (commentEl) {
        marker.addEventListener('mouseenter', () => {
          commentEl.classList.add('highlight');
        });
        marker.addEventListener('mouseleave', () => {
          commentEl.classList.remove('highlight');
        });

        commentEl.addEventListener('mouseenter', () => {
          marker.classList.add('highlight');
        });
        commentEl.addEventListener('mouseleave', () => {
          marker.classList.remove('highlight');
        });
      }
    });
  </script>
</Layout>
