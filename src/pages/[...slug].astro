---
import Layout from '../layouts/Layout.astro';
import Sidebar from '../components/Sidebar.astro';
import ContentRenderer from '../components/ContentRenderer.astro';
import { readMenusRecursively, extractAllPaths } from '../utils/menuLoader';

export async function getStaticPaths() {
  const menuStructures = await readMenusRecursively();
  const allPaths = extractAllPaths(menuStructures);

  return allPaths.map(path => ({
    params: { slug: path.slug },
    props: {
      title: path.title,
      content: path.content
    }
  }));
}

const { title, content } = Astro.props;
const { breadcrumb, sections } = content;
---

<Layout title={`${title} - Docs`}>
  <div class="sidebar-overlay" id="sidebar-overlay"></div>

  <main class="docs-layout">
    <Sidebar />

    <div class="content">
      <button class="menu-toggle" aria-label="Toggle menu" id="menu-toggle" onclick="playTerminalSound()">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <div class="breadcrumb">
        {breadcrumb.map((crumb, index) => (
          <>
            {index === 0 ? (
              <a href="/" onclick="playTerminalSound()">{crumb}</a>
            ) : index === breadcrumb.length - 1 ? (
              <span>{crumb}</span>
            ) : (
              <a href="#" onclick="playTerminalSound()">{crumb}</a>
            )}
            {index < breadcrumb.length - 1 && <span>›</span>}
          </>
        ))}
      </div>

      <div class="content-header">
        <h1>{title}</h1>
      </div>

      <section>
        <ContentRenderer sections={sections} />
      </section>
    </div>
  </main>

  <script>
    // Mobile menu toggle
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.getElementById('sidebar-overlay');

    function openMenu() {
      sidebar?.classList.add('mobile-open');
      overlay?.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      sidebar?.classList.remove('mobile-open');
      overlay?.classList.remove('active');
      document.body.style.overflow = '';
    }

    menuToggle?.addEventListener('click', () => {
      if (sidebar?.classList.contains('mobile-open')) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    overlay?.addEventListener('click', () => {
      if (typeof playTerminalSound === 'function') {
        playTerminalSound();
      }
      closeMenu();
    });

    // Cerrar menú al hacer click en un link
    const sidebarLinks = sidebar?.querySelectorAll('a');
    sidebarLinks?.forEach(link => {
      link.addEventListener('click', closeMenu);
    });
  </script>
</Layout>
